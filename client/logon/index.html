<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="/head.js"></script>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="../console/console.js"></script>
      <script src="authentication.js"></script>
      <link rel="stylesheet" type="text/css" href="/style.css" />
      <link rel="stylesheet" type="text/css" href="style.css" />
      <title>Bee.Fish logon</title>
      <style>
      </style>
   </head>
   <body>
      <script src="/body.js"></script>
      <h1>Logon</h1>
      <p>Click Secret to select your logon image.</p>
      <p>Complete logon by clicking your selected image.</p>
      <p>After logging in, checkout the draw link</p>
      <a href="authentication.js">authentication.js</a>
      <form id="form" onsubmit="return false;">
         <label for="secretFile">Secret</label>
         <input type="file" id="secretFile" onchange="createThumbnail(this.files[0]);" accept="image/*" style="display:none;" ></input>
         <img id="thumbnail" width="100" height="100" onclick="toggleLogon()" ></img>
         <canvas id="canvas" width="100" height="100" style="display:none;"></canvas>
         <h2><a id="link" href="/client/draw">Draw</a></h2>
         <script>
var console = new Console();
console.log("Hello world");

var authentication = new Authentication();

var form =
   document
   .getElementById("form");
 
var canvas =
   document
   .getElementById("canvas");
   
var thumbnail =
   document
   .getElementById("thumbnail");

var link =
   document
   .getElementById("link");
   
async function toggleLogon()
{
   if (authentication.authenticated) {
      if (confirm("Logoff?"))
         await logoff();
   }
   else
      await logon();
}

async function logon()
{
 
   thumbnail.classList.add("pressed");
   
   try {
      await authentication.logon();
   }
   catch (exception)
   {
      alert(exception);
   }
   
   if (authentication.authenticated)
   {
      // save the thumbnail
      sessionStorage.setItem(
         "authentication.thumbnail",
         authentication.secret
      );

      alert("Logged on");
   }
   
   updateForm();
   
}

async function logoff()
{

   thumbnail.classList.remove("pressed");
   await authentication.logoff();

   form.reset();
         
   updateForm();
   
}

async function createThumbnail(file)
{
   await authentication.logoff();
   thumbnail.classList.remove("pressed");
   
   // Create a thumbail copy from
   // secret file and draw it
   // on the canvas.
   
   var _this = this;
     
   prepareCanvas(canvas);
      
   var image;
      
      
   // Read the secretFile
   var fileReader = new FileReader();
      
   // onload fires after reading is complete
   fileReader.onload = createImage;
      
   // begin reading
   fileReader.readAsDataURL(file);
      
    
   function createImage()
   {
      image = new Image();
         
      image.width = 100;
            
      image.height = 100;
            
      image.onload = imageLoaded;
      
      image.src = fileReader.result;
         
   }
      
   async function imageLoaded()
   {
   
      var context = canvas.getContext("2d");
      
      // draw the image
      context.drawImage(
         image, 0, 0, canvas.width, canvas.height
      );         

      // get the image
      var jpeg =
         canvas.toDataURL("image/jpeg", 1.0);
     
      // set the thumbnail
      thumbnail.src = jpeg;
      
      // set the secret
      authentication.secret = jpeg

      
   }
      
   function prepareCanvas(canvas)
   {
      canvas.width = 100;    
      canvas.height = 100;
      
      var context = canvas.getContext("2d");
         
      // draw the image
      context.clearRect(
         0, 0, canvas.width, canvas.height
      );         
   }
      

}


function updateForm()
{
 
   var thumbnailSrc =
         sessionStorage.getItem(
            "authentication.thumbnail"
         );

   if (thumbnailSrc)
   {
      thumbnail.src = thumbnailSrc;
   }

   authentication.secret =
      thumbnail.src;
         
   if (authentication.authenticated)
   {
      thumbnail.classList.add("pressed");
      link.style.display = "block";
   }
   else
   {
      thumbnail.classList.remove("pressed");
      link.style.display = "none";
   }

   link.href = "../draw";
   link.innerHTML = "Draw";
   
   var cookies = document.cookie.split(";");
      cookies.forEach(
         cookie => {
            var parts = cookie.split("=");
            var name = parts[0];
            if (name == "redirect") {
               var value = parts[1];
               link.href = value;
               link.innerHTML = "Continue";
            }
            
         }
      );
      
}


document.body.onload = function()
{
   authentication.getStatus().then(
      status =>
         updateForm()
   );
}



         </script>

      </form>
        
   </body>
</html>
