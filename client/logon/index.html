<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="/head.js"></script>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="../console/console.js"></script>
      <script src="../sha3/sha3.js"></script>
      <script src="../sha3/hash-file.js"></script>
      <script src="authentication.js"></script>
      <link rel="stylesheet" type="text/css" href="/style.css" />
      <link rel="stylesheet" type="text/css" href="style.css" />
      <title>Bee.Fish logon</title>
      <style>
      </style>
   </head>
   <body>
      <script src="/body.js"></script>
      <h1>Logon</h1>
      <a href="authentication.js">authentication.js</a>
      <form id="form" onsubmit="return false;">
         <fieldset id="fieldset">
            <legend id="legend">Logon</legend>
            <details id="nameDetails" open="true">
               <summary>
                  A Name
               </summary>
               <input type="text" id="_name" onchange="updateForm()"></input>
            </details>
            <details id="secretFileDetails">
               <summary>
                  B Secret
               </summary>
               <input type="file" id="secretFile" accept="image/*" onchange="createSecret(this.files[0]);"></input>
               <br/>
               <progress id="progress" value="0" max="100" style="display:none;"></progress>
            </details>
            <details id="thumbnailDetails">
               <summary>
                  C Logon
               </summary>
               <figure id="localThumbailFigure">
                  <img id="localThumbnail" width="100" height="100" onclick="logon()" style="display:none;"></img>
                  <figcaption>Local</figcaption>
               </figure>
               <figure id="serverThumbnailFigure">
                  <img id="serverThumbnail" width="100" height="100" onclick="logoff()"></img>
                  <figcaption>Server</figcaption>
               </figure>
            </details>
         </fieldset>
         <canvas id="canvas" width="100" height="100" style="display:none;"></canvas>
      </form>
      <script>
var console = new Console();
console.log("Hello world");

var authentication = new Authentication();

var form =
   document
   .getElementById("form");
 
var progress =
   document
   .getElementById("progress");
   
var localThumbnailFigure =
   document
   .getElementById("localThumbailFigure");

var canvas =
   document
   .getElementById("canvas");
   
var serverThumbnailFigure =
   document
   .getElementById("serverThumbnailFigure");

var serverThumbnail =
   document
   .getElementById("serverThumbnail");
   
var localThumbnail =
   document
   .getElementById("localThumbnail");

var fieldset =
   document
   .getElementById("fieldset");

var nameDetails =
   document
   .getElementById("nameDetails");
   
var _name =
   document
   .getElementById("_name");
      
var secretFileDetails =
   document
   .getElementById("secretFileDetails");
   
var thumbnailDetails =
   document
   .getElementById("thumbnailDetails");
   
var legend =
   document
   .getElementById("legend");
   

async function logon()
{
 
   if (authentication.authenticated)
      return;
      
   canvas.classList.add("pressed");
   

   authentication.name =
      _name.value;
         
   try {
      await authentication.logon();
   }
   catch (exception)
   {
      alert(exception);
   }
   
   if (authentication.authenticated)
   {
      localStorage.setItem(
         "authentication.name",
         authentication.name
      );
      
      var logonFrom =
         sessionStorage.getItem(
            "authentication.logon-from"
         );
         
      if (logonFrom)
      {
         sessionStorage.removeItem(
            "authentication.logon-from"
         );
         window.location.href = logonFrom;
      }

   }
   
   updateForm();
   
   canvas.classList.remove("pressed");
   
}

async function logoff()
{

   serverThumbnail.classList.add("pressed");
   
   await authentication.logoff();

   form.reset();
         
   serverThumbnail.classList.remove("pressed");
   
   updateForm();
   
}

async function createSecret(secretFile)
{

   progress.style.display = "block";
   localThumbailFigure.style.display = "none";
   thumbnailDetails.open = false;
   
   onprogress = function(percent)
   {
      progress.value = percent;
   }
   
   createThumbnail(secretFile, canvas);

   const hash = await hashFile(
      secretFile,
      onprogress
   );
   
   authentication.secret = hash;
   
   progress.style.display = "none";
   updateForm();
}

function createThumbnail(file, canvas)
{
   // Create a thumbail copy from
   // secret file and draw it
   // on the canvas.
      
   var _this = this;
     
   prepareCanvas(canvas);
      
   var image;
      
      
   // Read the secretFile
   var fileReader = new FileReader();
      
   // onload fires after reading is complete
   fileReader.onload = createImage;
      
   // begin reading
   fileReader.readAsDataURL(file);
      
    
   function createImage()
   {
      image = new Image();
         
      image.width = 100;
            
      image.height = 100;
            
      image.onload = imageLoaded;
      
      image.src = fileReader.result;
         
   }
      
   function imageLoaded()
   {
   
      var context = canvas.getContext("2d");
         
      // draw the image
      context.drawImage(
         image, 0, 0, canvas.width, canvas.height
      );         

      var jpeg =
         canvas.toDataURL("image/jpeg");
     
      authentication.localThumbnail = jpeg;
      
      localThumbnail.src = authentication.localThumbnail;
      localStorage.setItem(
         "authentication.localThumbnail",
         authentication.localThumbnail
      );
      localThumbnail.style.display = "inline";
      localThumbailFigure.style.display = "inline";
      thumbnailDetails.open = true;

   }
      
   function prepareCanvas(canvas)
   {
      canvas.width = 100;    
      canvas.height = 100;
      
      var context = canvas.getContext("2d");
         
      // draw the image
      context.clearRect(
         0, 0, canvas.width, canvas.height
      );         
   }
      

}

async function getThumbnail()
{
    
   authentication.name =
      _name.value;
   
   await authentication.getThumbnail();
   
   updateForm();
}

async function updateForm()
{

   await authentication.getStatus();
   
   if (!_name.value)
      _name.value =
         localStorage.getItem(
            "authentication.name"
         );

   if (_name.value)
   {
      nameDetails.classList.remove("invalid");
      nameDetails.classList.add("valid");
      secretFileDetails.open = true;
   }
   else
   {
      nameDetails.classList.add("invalid");
      nameDetails.classList.remove("valid");
      secretFileDetails.open = false;
   }
   
   if (authentication.hasSecret)
   {
      secretFileDetails.classList.remove("invalid");
      secretFileDetails.classList.add("valid");
   }
   else
   {
      secretFileDetails.classList.add("invalid");
      secretFileDetails.classList.remove("valid");
      thumbnailDetails.open = false;
   }

   
   var localThumbnailSrc =
         localStorage.getItem("authentication.localThumbnail");
   
   if (localThumbnailSrc)
   {
      localThumbnail.src = localThumbnailSrc;
      localThumbnail.style.display = "inline";
   }
   else
      localThumbnail.style.display = "none";
      
   if (authentication.authenticated)
   {
      thumbnailDetails.open = true;
      thumbnailDetails.style.display = "block";
      
      fieldset.className = "valid";
      
      nameDetails.style.display = "none";
      secretFileDetails.style.display = "none";
      legend.innerHTML = _name.value;
      
      if (authentication.serverThumbnail == null)
      {
         await authentication.getThumbnail();
      }
   }
   else
   {
      fieldset.className = "invalid";
      
      nameDetails.style.display = "block";
      secretFileDetails.style.display = "block";
      
      if ( (_name.value && authentication.hasSecret) ||
           localThumbnail.src )
      {
         thumbnailDetails.style.display = "block";
         thumbnailDetails.open = true;
      }
      else
      {
         thumbnailDetails.style.display = "none";
         thumbnailDetails.open = false;
      }
      
      legend.innerHTML = "Logon";

   }

      
   if (authentication.serverThumbnail)
   {
      serverThumbnail.src = authentication.serverThumbnail;
      serverThumbnail.style.display = "inline";
   }
   else
   {
      serverThumbnail.src = "";
      serverThumbnail.style.display = "none";
   }
   
   
}


document.body.onload = async function()
{
   updateForm();
}



      </script>

   </body>
</html>
