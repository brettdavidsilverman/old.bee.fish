<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="/head.js"></script>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/>
<!--
      <link rel="stylesheet" type="text/css" href="/style.css" />
-->
      <link rel="stylesheet" type="text/css" href="style.css" />

      <title>Bee Hive</title>
      <script src="../client/fetch.js"></script>
      <script src="../client/logon/authentication.js"></script>
      <script src="../client/id/id.js"></script>
      <script src="../client/storage/storage.js"></script>
      <script src="../client/formatJSON.js"></script>
<!--
      <script src="../client/stream/stream.js"></script>
      <script src="../client/power-encoding/power-encoding.js"></script>
      <script src="../cllient/pointer/pointer.js"></script>
      <script src="../client/console/console.js"></script>
-->
      <style>
.number {
   width:50px;
   text-align:right;
}

.awake {
   color: green;
}

.asleep {
   color: red;
   text-decoration: none;
}

.container {
   height: 100%;
}

#lastImage {
   width: 400px;
   height: 300px;
   display: none;
}
      </style>
   </head>
   <body>
      <script src="/body.js"></script>
      <div>
         <h1>Bee Hive Console</h1>
      </div>
      <div class="container">
         <div class="top">
            <div id="lastStatus">Last Status</div>
            <h2><a id="beehiveURL" style="display:none;" class="asleep">Bee Hive #1</a></h2>

            <div id="nextWakeupCountDown">
               <h3>Next wake up in</h3>
               <b><span id="nextWakeup"></span></b>
               <br/>
               <br/>
               <form onchange="saveSettings()" id="form1">
                  Tick box to wake up next time <input type="checkbox" id="wakeupNextTime"></input>
               </form>
               <br/>
               Next wake up <span id="nextWakeupTime"></span>
            </div>

            <h3>Weather</h3>
            <table id="weatherTable"></table>

            <h3>Last Image</h3>
            <div id="lastImageTime"></div>
            <br/>
            <img id="lastImage" onclick="window.open(this.src, '_blank')"></img>

            <h3>Settings</h3>
            <form onchange="saveSettings()" id="form2">
               Wake up every <input type="number" value="1" id="wakeupEvery" class="number" min="1"></input> minutes
               <br />
               <br />
               Take picture every <input type="number" value="60" id="takePictureEvery" class="number"></input> minutes
               <br />
            </form>
            <br/>
         </div>
      </div>
      <script>
var nextWakeup = document.getElementById("nextWakeup");            
var form2 = document.getElementById("form2");
var storage = new RemoteStorage({url:  document.location.origin + "/beehive/"});
var lastStatus = document.getElementById("lastStatus");
var beehiveURL = document.getElementById("beehiveURL");
var wakeupNextTime = document.getElementById("wakeupNextTime");
wakeupNextTime.checked = false;
var nextWakeupTime = document.getElementById("nextWakeupTime");
var nextWakeupCountDown = document.getElementById("nextWakeupCountDown");
var lastSleepTime = document.getElementById("lastSleepTime");

var wakeupTime;

var wakeupEvery = document.getElementById("wakeupEvery");
var takePictureEvery = document.getElementById("takePictureEvery");
var temperature = document.getElementById("temperature");
var weatherTable = document.getElementById("weatherTable");
var lastImage = document.getElementById("lastImage");
var lastImageTime = document.getElementById("lastImageTime");
var setup;
var timeOutId;

function getSetup() {

   return storage.getItem("status")
      .then(
         function(text) {
            if (text == null || text.length == 0) {
               beehiveURL.style.display = "none";
               form2.style.display = "none";
            }
            else {
               setup = JSON.parse(text);
               // Label
               beehiveURL.innerHTML = "";
               var text = document.createTextNode(setup.label);
               beehiveURL.appendChild(text);
               
               // URL
               beehiveURL.style.display = "inline";
               beehiveURL.href = setup.url;

               // Wake up
               wakeupNextTime.checked = setup.wakeupNextTime;
               
               // Next wake up
               if (setup.wakeupTime) {
                  wakeupTime = Date.parse(setup.wakeupTime);
                  wakeupTime = new Date(wakeupTime);
                  nextWakeupTime.innerHTML = wakeupTime.toTimeString();
               }

               wakeupEvery.value = setup.wakeupEvery / 60;
               takePictureEvery.value = setup.takePictureEvery /60;

               if (setup.lastImageURL) {
                  if (setup.lastImageURL != lastImage.src)
                     lastImage.src = setup.lastImageURL;
                  if (setup.lastImageTime)
                     lastImageTime.innerHTML =
                        new Date(setup.lastImageTime).toTimeString();
                  lastImage.style.display = "block";
               }
               else
                  lastImage.style.display = "none";

               if (setup.lastWeatherURL) {
                  getWeather(setup.lastWeatherURL);
               }

               if (setup.sleeping) {
                  beehiveURL.classList.add("asleep");
                  beehiveURL.classList.remove("awake");
                  nextWakeupCountDown.style.display = "block";
               }
               else if (setup.wakeupNextTime) {
                  beehiveURL.classList.add("awake");
                  beehiveURL.classList.remove("asleep");
                  nextWakeupCountDown.style.display = "none";
               }

               form2.style.display = "block";
            }
            lastStatus.innerHTML = "";
            timeOutId = window.setTimeout(
               getSetup,
               5000
            );
         }
      ).catch(
         function(error) {
            lastStatus.innerHTML = error;
            authenticate();
            timeOutId = window.setTimeout(
               getSetup,
               5000
            );
         }
      );
}

function validateForm() {
   alert (wakeupEvery.value);
   return false;
}

function saveSettings() {
   if (!setup)
      return;
/*
   if (Number(wakeupEvery.value) > 255) {
      alert("Wake up every maximum is 255");
      return false;
   }
*/
   setup.wakeupNextTime = wakeupNextTime.checked;
   setup.wakeupEvery = Number(wakeupEvery.value) * 60;
   setup.takePictureEvery = Number(takePictureEvery.value) * 60;
   
   window.clearTimeout(timeOutId);

   var string = JSON.stringify(setup);
   storage.setItem("setup", string, "application/json; charset=utf-8")
   .then(
      function() {
         lastStatus.innerHTML = "Saved";
         return getSetup();
      }
   )
   .catch(
      function(error) {
         lastStatus.innerHTML = error;
         return getSetup();
      }
   );

   return true;
}  

function getWeather(weatherURL) {
   
   var params = {
      credentials: "include"
   };

   fetch(weatherURL, params)
   .then(
      function(response) {
         return response.json();
      }
   )
   .then(
      function(json) {
         weatherTable.innerHTML = "";
         formatJSON(json, weatherTable);
      }
   )
   .catch(
      function(error) {
         alert(error);
         weatherTable.innerHTML = "";
         var tr = document.createElement("tr");
         var td = document.createElement("td");
         td.innerHTMNL = error;
         tr.appendChild(td);
         weatherTable.appendChild(tr);
      }
   );
}

wakeupNextTime.checked = false;
beehiveURL.disabled = true;

getSetup().then(
   function() {
      getCountDown();
      window.setInterval(getCountDown, 1000)
   }
);


function getCountDown() {
   if (wakeupTime > new Date()) {
      var date = new Date(wakeupTime - Date.now());
      var string;
      string =
         date.getUTCHours() + " hours " +
         date.getUTCMinutes() + " minutes " +
         date.getUTCSeconds() + " seconds";
      nextWakeup.innerHTML = string;
   }
   else {
      nextWakeup.innerHTML = "Timer expired";
   }
}

window.load = authenticate;

      </script>

   </body>
</html>
