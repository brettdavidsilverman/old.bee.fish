<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="../head.js"></script>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="../console/console.js"></script>
      <script src="../power-encoding/bit-string/bit-string.js"></script>
      <script src="../power-encoding/stream/stream.js"></script>
      <script src="../power-encoding/number/number.js"></script>
      <script src="../power-encoding/string/string.js"></script>
      <script src="../short-hand/short-hand.js"></script>
      <script src="../id/id.js"></script>
      <script src="../pointer/pointer.js"></script>
      <script src="../object/object.js"></script>
      <script src="../memory/memory.js"></script>
      <script src="image.js"></script>
      <link rel="stylesheet" type="text/css" href="../style.css" />
      <title>Image</title>
   </head>
   <body>
      <script src="/body.js"></script>
      <h1>Image</h1>

      <a href="./image.js">image.js</a>
      <h2>Image Constructor</h2>
      <pre>
         <script>
var storage = Memory.storage;
storage.clear();
var key;
var image = new Image();
image.onload = function() {
   key = image.save();
   document.writeln("loaded " + this.src);
}

image.src = "/feebee.jpg";
         </script>
      </pre> 
      <h2>Image Fetch</h2>
      <pre>
         <script>
image = Memory.fetch(key);

document.writeln(image);

document.writeln("Done");
         </script>
      </pre> 
      <!--
      <h2>Save/Fetch</h2>
      
      <h3>Simple structures</h3>
      <pre>
         <script>
Memory.storage.clear();

class Base {
   constructor(input) {
      Object.assign(this, input);
      
      if (input && input.id) 
         this.id = new Id(input.id);
      else
         this.id = new Id(
            this.constructor.name
         );
   }
   
   
}

class Person extends Base {
   constructor(input) {
      super(input);
   }
}

var brett = new Person(
   {
      lastName:  "Silverman",
      firstName: "Brett"
      
   }
);

document.writeln(
   brett.toString(ShortHand.full)
);

var key = brett.save();

document.writeln(
   key === brett.id.key
);

var brettFetched = Memory.fetch(key);

document.writeln(
   key === brettFetched.id.key
);

document.writeln(
   brettFetched.constructor.name
);

document.writeln(
   brettFetched.toString(
      ShortHand.short
   )
);

      </script>
   </pre>

   <h3>Structures</h3>
   
   <pre>
      <script>
      
class Car extends Base {

   constructor(input) {
      super(input);
   }
   
}

var car = new Car(
   {
      make:  "Honda",
      model: "Prelude",
      driver: brett
   }
);

var key = car.save();

car = Memory.fetch(key);

document.writeln(car);
document.writeln(car.driver);


         </script>
      </pre>

      <h3>Saving doesnt recurse</h3>
      
      <p>When saving, the getters return pointers
         as opposed to dereferenced objects. This
         prevents stored objects from being fetched
         each time the root object is saved.</p>
      <pre>
         <script>

console.log = function(value) {
   document.writeln(value);
}

try {
   Memory.storage.clear();
   
   function A(input) {
      Object.assign(this, input);
      if (input) {
         if (input.id)
            this.id = new Id(input.id);
         if (input.b);
            this.b = new B(input.b);
      }
      else {
         this.a = "a";
         this.b = new B();
      }
   }
   
   function B(input) {
      Object.assign(this, input);
      if (input) {
         if (input.id)
            this.id = new Id(input.id);
      }
      else
         this.b = "b";
      
      this.save = function() {
         document.writeln("Saving B");
         return Object.prototype.save.call(this);
      }
   }
   
   var a = new A();
   document.writeln(ToString(a));
   
   document.writeln("Should trigger saving B");
   var key = a.save();
   a = Memory.fetch(key);
  // console.log(a);
   document.writeln("Should not trigger saving B");
   key = a.save();
   a = Memory.fetch(key);
   document.writeln(ToString(a));
   document.writeln(Memory.storage);
}
catch (error) {
   alert(error.stack);
}
         </script>
      </pre>
      
      <h3>Removing items to free up storage</h3>
      <pre>
         <script>
var storage = Memory.storage;
storage.clear();

var object = {
   a: "a",
   b: {
      b: "b"
   },
   c: [0, 1, 2, {"3": "three"}]
}
object.d = object;

var key = object.save();

object = Memory.fetch(key);

document.writeln(object);

document.writeln("Before remove");
document.writeln(storage);

object.remove();

document.writeln("After remove");

document.writeln(storage);

document.writeln("Done");
         </script>
      </pre>
      
      <h3>Storing the image object</h3>
      <pre>
         <script>
var storage = Memory.storage;
storage.clear();

var image = new Image();

var key = image.save();

document.writeln(key);

image = Memory.fetch(key);

document.writeln(image);

document.writeln("Done");
         </script>
      </pre> 
       -->
   </body>
</html>