<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="/head.js"></script>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="../client/console/console.js"></script>
      <script src="../client/stream/stream.js"></script>
      <script src="../client/power-encoding/power-encoding.js"></script>
      <script src="../client/bit-string/bit-string.js"></script>
      <script src="../client/number/number.js"></script>
      <script src="../client/id/id.js"></script>
      <script src="../client/base64/base64.js"></script>
      <script src="../client/sha3/sha3.js"></script>
      <script src="../client/sha3/hash-secretFile.js"></script>
      <script src="../client/pointer/pointer.js"></script>
      <script src="../client/shorthand/shorthand.js"></script>
      <script src="../client/object/object.js"></script>
      <script src="authentication.js"></script>
      <link rel="stylesheet" type="text/css" href="/style.css" />
      <title>Bee.Fish logon</title>
      <style>
input, progress, button {
   width: 100%;
}

fieldset {
   background-color: lightblue;
}

fieldset, input, button, img, canvas {
   border: none;
   box-shadow: 5px 5px 3px grey;
}

progress, input, button, img, canvas {
   background-color: lightyellow;
   margin-bottom: 5px;
}

progress {
   margin-top: 5px;
}

button {
   background-color: lightgreen;
}

figure {
    float: left;
    text-align: center;
}

.valid {
   background-color: lightgreen;
}

.invalid {
   background-color:  #FF7F87;
}

.pressed {
   bordera: 1px solid black;
   box-shadow: inset 5px 3px grey;
}


      </style>
   </head>
   <body>
      <script src="/body.js"></script>
      <h1>Logon</h1>
      <a href="authentication.js">authentication.js</a>
      <form id="form" onsubmit="return false;">
         <fieldset id="fieldset">
            <legend id="legend">Logon</legend>
            <details id="nameDetails" open="true">
               <summary>
                  A Name
               </summary>
               <input type="text" id="_name" onchange="updateForm()"></input>
            </details>
            <details id="secretFileDetails">
               <summary>
                  B Secret
               </summary>
               <input type="file" id="secretFile" onchange="createSecret(this.files[0]);"></input>
               <br/>
               <progress id="progress" value="0" max="100" style="display:none;"></progress>
            </details>
            <details id="thumbnailDetails">
               <summary>
                  C Logon
               </summary>
               <figure id="localThumbailFigure" style="display:none">
                  <canvas id="canvas" width="100" height="100" onclick="logon()"></canvas>
                  <figcaption>Local</figcaption>
               </figure>
               <figure id="serverThumbnailFigure" style="display:none">
                  <img id="serverThumbnail" width="100" height="100" onclick="logoff()"></img>
                  <figcaption>Server</figcaption>
               </figure>
            </details>
            <!--
            <br />
            <button id="button" onclick="logon()">Logon</button>
            -->
         </fieldset>
      </form>
      <script>
var console = new Console();
console.log("Hello world");

var bee = new Authentication();

var form =
   document
   .getElementById("form");
 
var progress =
   document
   .getElementById("progress");
   
var localThumbnailFigure =
   document
   .getElementById("localThumbailFigure");

var canvas =
   document
   .getElementById("canvas");
   
var serverThumbnailFigure =
   document
   .getElementById("serverThumbnailFigure");

var thumbnail =
   document
   .getElementById("serverThumbnail");
   
var fieldset =
   document
   .getElementById("fieldset");

var nameDetails =
   document
   .getElementById("nameDetails");
   
var _name =
   document
   .getElementById("_name");
      
var secretFileDetails =
   document
   .getElementById("secretFileDetails");
   

var legend =
   document
   .getElementById("legend");
   

async function logon()
{
 
   updateForm();
   
   canvas.classList.add("pressed");
   
   bee.name =
      _name.value;
   
   if (!bee.name)
   { 
      alert("Missing name");
      return false;
   }

   
      
   if (!bee.hasSecret)
   {
      alert("Missing secret file");
      return false;
   }
      
   try {
      await bee.logon();
   }
   catch (exception)
   {
      alert(exception);
      return false;
   }
   
   
   if (bee.authenticated)
   {
      await getThumbnail();
   }
   else
      alert("Error");

   updateForm();
   
   canvas.classList.remove("pressed");
   
}

async function logoff()
{
   await bee.logoff();

   form.reset();
         
   localThumbnailFigure
      .style
      .display = "none";
            
   serverThumbnailFigure
       .style
       .display = "none";
         
   secretFileDetails.open = false;
         
   updateForm();
   
}

async function createSecret(secretFile)
{

   progress.style.display = "block";
   localThumbailFigure.style.display = "none";
   
   bee.onprogress = function(percent)
   {
      progress.value = percent;
   }
   
   await bee.createSecret(
      secretFile,
      canvas
   );
   
   progress.style.display = "none";
   localThumbailFigure.style.display = "inline";
   
   updateForm();
}


async function getThumbnail()
{
   
   if (!_name.value)
      console.log("Missing name");
   
   if (!bee.hasSecret)
      console.log("Missing secret");
 
    
   bee.name =
      _name.value;
   
   await bee.getThumbnail();
   
   if (bee.thumbnail)
   {
      thumbnail.src = bee.thumbnail;
      serverThumbnailFigure.style.display = "inline";
   }
   else
   {
      thumbnail.src = "";
      serverThumbnailFigure.style.display = "none";
   }
}

function updateForm()
{
   if (_name.value)
   {
      nameDetails.classList.remove("invalid");
      nameDetails.classList.add("valid");
      secretFileDetails.open = true;
   }
   else
   {
      nameDetails.classList.add("invalid");
      nameDetails.classList.remove("valid");
      secretFileDetails.open = false;
   }
   
   if (bee.hasSecret)
   {
      secretFileDetails.classList.remove("invalid");
      secretFileDetails.classList.add("valid");
      if (_name.value)
         thumbnailDetails.open = true;
      else
         thumbnailDetails.open = false;
   }
   else
   {
      secretFileDetails.classList.add("invalid");
      secretFileDetails.classList.remove("valid");
      thumbnailDetails.open = false;
   }

   if (bee.authenticated)
   {
      thumbnailDetails.open = true;
      legend.innerHTML =
         "Logged in as " + bee.name;
      fieldset.className = "valid";
      secretFileDetails.style.display = "none";
      nameDetails.style.display = "none";
   }
   else
   {
      legend.innerHTML = "Logon";
      fieldset.className = "invalid";
      secretFileDetails.style.display = "block";
      nameDetails.style.display = "block";
      
      if (_name.value && bee.hasSecret)
         thumbnailDetails.open = true;
      else
         thumbnailDetails.open = false;
   }

   progress.style.display = "none";
}

bee.onthumbnailloaded = function()
{
   localThumbailFigure.style.display = "inline";
}

window.onload = async function()
{
   await bee.getStatus();
   
   if ( bee.authenticated )
   {
      thumbnail.src = bee.thumbnail;
      thumbnail.style.display = "inline";
      localThumbnailFigure.style.display = "inline";
      serverThumbnailFigure.style.display = "inline";
   }
   else
   {
      localThumbnailFigure.style.display = "none";
      serverThumbnailFigure.style.display = "none";
   }
   
      
   updateForm();
}



      </script>

   </body>
</html>
