<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="/head.js"></script>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="../client/console/console.js"></script>
      <script src="../client/stream/stream.js"></script>
      <script src="../client/power-encoding/power-encoding.js"></script>
      <script src="../client/bit-string/bit-string.js"></script>
      <script src="../client/number/number.js"></script>
      <script src="../client/id/id.js"></script>
      <script src="../client/base64/base64.js"></script>
      <script src="../client/sha3/sha3.js"></script>
      <script src="../client/sha3/hash-secretFile.js"></script>
      <script src="../client/pointer/pointer.js"></script>
      <script src="../client/shorthand/shorthand.js"></script>
      <script src="../client/object/object.js"></script>
      <script src="authentication.js"></script>
      <link rel="stylesheet" type="text/css" href="/style.css" />
      <link rel="stylesheet" type="text/css" href="style.css" />
      <title>Bee.Fish logon</title>
      <style>
      </style>
   </head>
   <body>
      <script src="/body.js"></script>
      <h1>Logon</h1>
      <a href="authentication.js">authentication.js</a>
      <form id="form" onsubmit="return false;">
         <fieldset id="fieldset">
            <legend id="legend">Logon</legend>
            <details id="nameDetails" open="true">
               <summary>
                  A Name
               </summary>
               <input type="text" id="_name" onchange="updateForm()"></input>
            </details>
            <details id="secretFileDetails">
               <summary>
                  B Secret
               </summary>
               <input type="file" id="secretFile" accept="image/*" onchange="createSecret(this.files[0]);"></input>
               <br/>
               <progress id="progress" value="0" max="100" style="display:none;"></progress>
            </details>
            <details id="thumbnailDetails">
               <summary>
                  C Logon
               </summary>
               <figure id="localThumbailFigure">
                  <img id="localThumbnail" width="100" height="100" onclick="logon()"></img>
                  <figcaption>Local</figcaption>
               </figure>
               <figure id="serverThumbnailFigure">
                  <img id="serverThumbnail" width="100" height="100" onclick="logoff()"></img>
                  <figcaption>Server</figcaption>
               </figure>
            </details>
         </fieldset>
         <canvas id="canvas" width="100" height="100" style="display:none;"></canvas>
      </form>
      <script>
var console = new Console();
console.log("Hello world");

var bee = new Authentication();

var form =
   document
   .getElementById("form");
 
var progress =
   document
   .getElementById("progress");
   
var localThumbnailFigure =
   document
   .getElementById("localThumbailFigure");

var canvas =
   document
   .getElementById("canvas");
   
var serverThumbnailFigure =
   document
   .getElementById("serverThumbnailFigure");

var serverThumbnail =
   document
   .getElementById("serverThumbnail");
   
var localThumbnail =
   document
   .getElementById("localThumbnail");

var fieldset =
   document
   .getElementById("fieldset");

var nameDetails =
   document
   .getElementById("nameDetails");
   
var _name =
   document
   .getElementById("_name");
      
var secretFileDetails =
   document
   .getElementById("secretFileDetails");
   
var thumbnailDetails =
   document
   .getElementById("thumbnailDetails");
   
var legend =
   document
   .getElementById("legend");
   

async function logon()
{
 
   if (bee.authenticated)
      return;
      
   canvas.classList.add("pressed");
   

   bee.name =
      _name.value;
         
   try {
      await bee.logon();
   }
   catch (exception)
   {
      alert(exception);
   }
   
   if (bee.authenticated)
   {
      localStorage.setItem(
         "bee.authentication.name",
         bee.name
      );
   }
   
   updateForm();
   
   canvas.classList.remove("pressed");
   
}

async function logoff()
{

   serverThumbnail.classList.add("pressed");
   
   await bee.logoff();

   form.reset();
         
   serverThumbnail.classList.remove("pressed");
   
   updateForm();
   
}

async function createSecret(secretFile)
{

   progress.style.display = "block";
   localThumbailFigure.style.display = "none";
   thumbnailDetails.open = false;
   
   bee.onprogress = function(percent)
   {
      progress.value = percent;
   }
   
   bee.onthumbnailloaded = function()
   {
      localThumbnail.src = bee.localThumbnail;
      localStorage.setItem(
         "bee.authentication.localThumbnail",
         bee.localThumbnail
      );
      localThumbailFigure.style.display = "inline";
      thumbnailDetails.open = true;
   }
   
   await bee.createSecret(
      secretFile,
      canvas
   );
   

   updateForm();
}


async function getThumbnail()
{
    
   bee.name =
      _name.value;
   
   await bee.getThumbnail();
   
   updateForm();
}

async function updateForm()
{
   await bee.getStatus();
   
   if (!_name.value)
      _name.value =
         localStorage.getItem(
            "bee.authentication.name"
         );

   if (_name.value)
   {
      nameDetails.classList.remove("invalid");
      nameDetails.classList.add("valid");
      secretFileDetails.open = true;
   }
   else
   {
      nameDetails.classList.add("invalid");
      nameDetails.classList.remove("valid");
      secretFileDetails.open = false;
   }
   
   if (bee.hasSecret)
   {
      secretFileDetails.classList.remove("invalid");
      secretFileDetails.classList.add("valid");
   }
   else
   {
      secretFileDetails.classList.add("invalid");
      secretFileDetails.classList.remove("valid");
      thumbnailDetails.open = false;
   }

   localThumbnail.src =
         localStorage.getItem("bee.authentication.localThumbnail");

   if (bee.authenticated)
   {
      thumbnailDetails.open = true;
      thumbnailDetails.style.display = "block";
      
      fieldset.className = "valid";
      
      nameDetails.style.display = "none";
      secretFileDetails.style.display = "none";
      legend.innerHTML = _name.value;
   }
   else
   {
      fieldset.className = "invalid";
      
      nameDetails.style.display = "block";
      secretFileDetails.style.display = "block";
      
      if ( (_name.value && bee.hasSecret) ||
           localThumbnail.src )
      {
         thumbnailDetails.style.display = "block";
         thumbnailDetails.open = true;
      }
      else
      {
         thumbnailDetails.style.display = "none";
         thumbnailDetails.open = false;
      }
      
      legend.innerHTML = "Logon";

   }

      
   if (bee.serverThumbnail)
   {
      serverThumbnail.src = bee.serverThumbnail;
      serverThumbnail.style.display = "inline";
   }
   else
   {
      serverThumbnail.src = "";
      serverThumbnail.style.display = "none";
   }
   
   progress.style.display = "none";
}


document.body.onload = async function()
{
   updateForm();
}



      </script>

   </body>
</html>
