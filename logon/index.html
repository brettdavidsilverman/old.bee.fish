<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="/head.js"></script>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <script src="../client/console/console.js"></script>
      <script src="../client/stream/stream.js"></script>
      <script src="../client/power-encoding/power-encoding.js"></script>
      <script src="../client/bit-string/bit-string.js"></script>
      <script src="../client/number/number.js"></script>
      <script src="../client/id/id.js"></script>
      <script src="../client/base64/base64.js"></script>
      <script src="../client/sha3/sha3.js"></script>
      <script src="../client/sha3/hash-file.js"></script>
      <script src="../client/pointer/pointer.js"></script>
      <script src="../client/shorthand/shorthand.js"></script>
      <script src="../client/object/object.js"></script>
      <script src="authentication.js"></script>
      <link rel="stylesheet" type="text/css" href="../style.css" />
      <title>Bee.Fish logon</title>
      <style>
body {
   background-image: none;
}

input, progress, button {
   width: 100%;
}

fieldset {
   background-color: lightblue;
}

fieldset, input, button, img, canvas {
   border: none;
   box-shadow: 5px 5px 3px grey;
}

progress, input, button, img, canvas {
   background-color: lightyellow;
   margin-bottom: 5px;
}

progress {
   margin-top: 5px;
}

button {
   background-color: lightgreen;
}

figure {
    float: left;
    text-align: center;
}

.valid {
   background-color: lightgreen;
}

.invalid {
   background-color:  #FF7F87;
}


      </style>
   </head>
   <body>
      <script src="/body.js"></script>
      <h1>Logon</h1>
      <a href="authentication.js">authentication.js</a>
      <form id="form" onsubmit="return false;">
         <fieldset id="fieldset">
            <legend id="legend">Logon</legend>
            <details id="usernameDetails">
               <summary>
                  <label for="username">Username</label>
               </summary>
               <input type="text" id="username" onchange="usernameChanged(this)" onkeydown="usernameChanged(this)"></input>
            </details>
            <details id="fileDetails">
               <summary>
                  <label for="file">File</label>
               </summary>
               <input type="file" id="secret" onchange="hashFile(this.files[0]);"></input>
               <br/>
               <progress id="progress" value="0" max="100" style="display:none;"></progress>
            </details>
            <div>
               <figure id="localThumbailFigure" style="display:none" onclick="toggleLogon()">
                  <canvas id="canvas" width="100" height="100"></canvas>
                  <figcaption>Local</figcaption>
               </figure>
               <figure id="serverThumbnailFigure" style="display:none" onclick="toggleLogon()">
                  <img id="serverThumbnail" width="100" height="100"></img>
                  <figcaption>Server</figcaption>
               </figure>
            </div>
            <!--
            <br />
            <button id="button" onclick="logon()">Logon</button>
            -->
         </fieldset>
      </form>
      <script>

var console = new Console();
console.log("Hello world");

var bee = new Authentication();

var form =
   document
   .getElementById("form");
 
var progress =
   document
   .getElementById("progress");
   
var localThumbnailFigure =
   document
   .getElementById("localThumbailFigure");

var canvas =
   document
   .getElementById("canvas");
   
var serverThumbnailFigure =
   document
   .getElementById("serverThumbnailFigure");

var thumbnail =
   document
   .getElementById("serverThumbnail");
   
var fieldset =
   document
   .getElementById("fieldset");
  
var username =
   document
   .getElementById("username");
      
var legend =
   document
   .getElementById("legend");
   
var fileDetails =
   document
   .getElementById("fileDetails");
   
var usernameDetails =
   document
   .getElementById("usernameDetails");
   
async function logon()
{
   bee.username =
      username.value;
 
   if (!bee.username)
   {
      alert("Missing username.");
      return false;
   }
   
   if (!bee.hasSecret)
   {
      alert("Missing secret file.");
      return false;
   }
      
   var retval =
      await bee.logon()
      .catch(
         function(exception) {
            console.log(exception)
         }
      );
      
   if (!retval)
      alert("Invalid credentials");
      
   setThumbnail();
   setLogonStatus();
}

async function logout()
{
   bee.logout();
         
   form.reset();
         
   localThumbnailFigure
      .style
      .display = "none";
            
   serverThumbnailFigure
       .style
       .display = "none";
         
   fileDetails.open = false;
         
   setLogonStatus();
   
}

async function toggleLogon()
{
   if (bee.authenticated)
   {
      if (confirm("Do you want to log out of server?"))
      {
         logout();
      }
   }
   else
   {
      if (username.value && bee.hasSecret)
      {
         logon();
      }
   }
}

async function hashFile(file)
{
   progress.style.display = "block";
   localThumbailFigure.style.display = "none";
   
   bee.onprogress = function(percent)
   {
      progress.value = percent;
   }
   
   await bee.hashFile(
      file,
      canvas
   );
   
   progress.style.display = "none";
   localThumbailFigure.style.display = "inline";
   
   if (username.value)
      logon();
}


async function usernameChanged()
{

   bee.username =
      username.value;
 
   fileDetails.open = (bee.username != null);
   
   var retval = await bee.checkUsernameExists();
   
   if (bee.usernameExists)
   {
      getThumbnail();
         
   }
   else if (bee.username != null && bee.username.length > 0)
   {
      serverThumbnailFigure
         .style
         .display = "none";
   }

      
   setLogonStatus();
}

async function getThumbnail()
{
   bee.username =
      username.value;
   
   if (!bee.username)
      console.log("Missing username.");
   
 
   bee.getThumbnail()
      .then(
         setThumbnail
      );

}

function setThumbnail()
{
   if (bee.thumbnail)
   {
      thumbnail.src = bee.thumbnail;
      serverThumbnailFigure.style.display = "inline";
   }
   else
   {
      thumbnail.src = "";
      serverThumbnailFigure.style.display = "none";
   }
}

function setLogonStatus()
{
   if (bee.authenticated)
   {
      legend.innerHTML =
         "Logged in as " + bee.username;
      fieldset.className = "valid";
      fileDetails.style.display = "none";
      usernameDetails.style.display = "none";
   }
   else
   {
      legend.innerHTML = "Logon";
      fieldset.className = "invalid";
      fileDetails.style.display = "block";
      usernameDetails.style.display = "block";
   }

}

bee.onthumbnailloaded = function()
{
   localThumbailFigure.style.display = "inline";
}

window.onload = function()
{
   setLogonStatus();
}



      </script>

   </body>
</html>
