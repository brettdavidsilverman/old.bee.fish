<!DOCTYPE html>
<html lang="en">
   <head>
      <script src="/head.js"></script>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <link rel="stylesheet" type="text/css" href="/style.css" />
      <title>boost::asio Secure Server</title>
   </head>
   <body>
      <script src="/body.js"></script>
      <h1 id="h1">Boost ASIO Secure Server</h1>

      <ul>
         <li>
            <a href="Makefile">Makefile</a>
         </li>
         <li>
            <a href="main.cpp">main.cpp</a>
         </li>
         <li>
            <a href="server.h">server.h</a>
         </li>
         <li>
            <a href="server.cpp">server.cpp</a>
         </li>
         <li>
            <a href="https_session.h">https_session.h</a>
         </li>
         <li>
            <a href="https_session.cpp">https_session.cpp</a>
         </li>
      </ul>
      <pre>
         <script>

class Range extends Array {
   constructor(a, b) {
      super([a, b]);
   }
   
   match(character) {
      var matched =
         (this[0] <= character) &&
         (this[1] >= character);
      if (matched)
         this.success = true;
      else if (!this.success)
         this.failed = true;
   }
}

class Sequence extends String {
   #index = 0;
   constructor(string) {
      super(string);
   }
   
   match(character) {
      if ( this[this.#index] ===
           character
         )
      {
         ++this.#index;
         if (this.#index === this.length)
            this.success = true;
         return true;
      }
      
      this.failed = true;
      return false;
   }
}

class Matches extends Array {
   constructor(...matches) {
      super(...matches);
   }
   
   match(character) {
      for (index in this) {
         var item = this[index]
         if (item.match(character)) {
            if (item.success)
               this.success = true;
            return true;
         }
      }
      this.failed = true;
      return false;
   }
}

class Series extends Array {
   #index = 0;
   
   constructor(...series) {
      super(...series);
   }
   
   match(character) {
      var matched;
      for ( ;
            this.#index < this.length &&
            !(
               matched =
                  this[this.#index]
                  .match(character)
             );
            ++this.#index )
         ;
         
      if (this[this.#index - 1].failed)
         this.failed = true;
      else if (this.#index == this.length) {
         var success = true
         this.forEach(
            (item) => {
               if (!item.success)
                  success = false;
            }
         );
         this.#success = success;
      }
         
      return matched;
   }
}

class Not extends Matches {
   constructor(...not) {
      super(...not)
   }
   
   match(character) {
      var matched =
         !super.match(character);
      if (matched)
         this.success = true;
      else if (!this.success)
         this.failed = true;
   }
}

class Capture extends Object {
   #keys;
   #key = null;
   #index = 0;
   #value = "";
   #series;
   constructor(object) {
      super(object);
      this.#series = new Series(
         Object.values(object)
      );
      this.#keys = Object.keys(this);
      this.#key = this.#keys[0];
   }
   
   match(character) {
      var matched =
        this.#series.match(character);
        
      if (matched)
         this.#value += character;
      else {
         this[this.#key] = this.#value;
         this.#value = "";
         this.#key =
            this.#keys[++this.#index];
      }
   }
   
}

class Repeat extends Array {
   #exitCondituon;
   #Match;
   #match
   constructor(Match) {
      super(0);
      this.#Match = Match;
      this.#match = new this.#Match();
   }
   
   match(character) {
 
      if ( !this.#match
            .match(character) ) {
         
         this.push(this.#match);

         this.#match = new this.#Match();
         return
            this.#match.match(
               character
            );
      }
      
      return true;
   }
   
}

class WhiteSpace {
   match(character) {
      return
         ( character === " " ||
           character === "\t" );
   }
}

class Colon extends Series {
   constructor() {
       super(
          new WhiteSpace(),
          {
             match: (character) => {
                return character === ":";
             }
          },
          new WhiteSpace()
       );
   }
   
}

class NewLine {
   #firstChar = true;
   
   match(character) {
      if (this.#firstChar) {
         this.#firstChar = false;
         if (character === "\r") {
            return true;
         }
      }
      
      if (character === "\n")
         return true;
         
      return false;
   }
   
}

class FirstLine extends Capture {

   constructor() {
      super( {
         verb: new Matches(
            new Range("a", "z"),
            new Range("A", "Z"),
            "_"
         ),
         path: new Not(
            " ",
            "\t"
         ),
         version:
            new Sequence("HTTP/1.1"),
         newLine:
            new NewLine()
     } );
   }
}

class Header extends Capture {
   constructor() {
      super({
         name: new Matches(
            new Range("a", "z"),
            new Range("A", "Z"),
            "_"
         ),
         colon: new Colon(),
         value: new Matches(
            new Range("a", "z"),
            new Range("A", "Z"),
            "_"
         )
      });
   }
}

var request = [
   "GET / HTTP/1.1",
   "Host: bee.fish",
   "User-Agent: curl/7.64.0",
   "Accept: */*"
].join("\r\n");


class Request  {
   #string = "";
   #index = 0;
   #character = null;
   #grammer = new Capture( {
      firstLine: new FirstLine(),
      headers: new Repeat(
         Header
      ),
      newLine1: new NewLine(),
      newLine2: new NewLine()
   });
   
   #current;
   
   constructor() {
      this.#current =
        this.#grammer.verb;
   }
   
   read(next) {
      this.#string = next;
      this.#index = 0;
      while (
         this.#index <
         this.#string.length
      )
      {
         if (!this.#grammer.match(
              character))
            throw new Error(
               "Invalid request " + 
               this.#string
            );
      }
   }
   

}

var req = new Request(request);

document.writeln(req);

         </script>
      </pre>
   </body>
</html>
